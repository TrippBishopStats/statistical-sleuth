---
title: "Chapter 2" 
author: "Tripp Bishop" 
format: html
editor: source
---
```{r setup}
#| echo: false
#| message: false

rm(list = ls())
library(tidyverse)
library(tidymodels)
```
We first create a dataframe to store our data.
```{r sparrow data}
survived <- rep(c(TRUE, FALSE), times=c(35,24))
humerus_length_in <- c(
  #survivors
  0.687,0.703,0.709,0.715,0.721,0.723,0.723,0.726,0.728,0.728,0.728,
  0.729,0.730,0.730,0.733,0.733,0.735,0.736,0.739,0.741,0.741,0.741,
  0.741,0.743,0.749,0.751,0.752,0.752,0.755,0.756,0.766,0.767,0.769,
  0.770,0.780,
  # victims
  0.659,0.689,0.702,0.703,0.709,0.713,0.720,0.720,0.726,0.726,0.729,
  0.731,0.736,0.737,0.738,0.738,0.739,0.743,0.744,0.745,0.752,0.752,
  0.754,0.765
)
df_sparrows <- tibble(humerus_length_in, survived) |>
  mutate(
    survived = factor(survived, labels = c("Perished", "Survived"))
  )
```
Since we have already collected and stored the data, the next step is to
calculate the test statistic. Here, we're interested in the difference in means
of the length of the humerus bone in the two groups of sparrows.
```{r create test statistic}
obs_diff <- df_sparrows |>
  specify(humerus_length_in ~ survived) |>
  calculate(stat = "diff in means", order = c("Survived", "Perished")) |>
  pull()
```
Now, we create a `null world` where we create a sampling distribution where the
survival of the individual birds is independent of their humerus length.
```{r creat null distribution}
sparrows_null <- df_sparrows |>
  specify(humerus_length_in ~ survived) |>
  hypothesise(null = "independence") |>
  generate(reps = 1500, type = "permute") |>
  calculate(stat = "diff in means", order = c("Survived", "Perished"))
p_value <- round(
  get_p_value(sparrows_null, obs_stat = obs_diff, direction = "both"),
  4
)
visualise(sparrows_null) +
  shade_p_value(obs_diff, direction = "both") +
  annotate("text", label = paste("p-value = ", p_value, sep=""), x = 0.014, y=150)
```
```{r t-test manual}
sd_died <- df_sparrows |>
  filter(survived == "Perished") |>
  summarise(
    std_dev = sd(humerus_length_in)
  ) |>
  pull()
sd_lived <- df_sparrows |>
  filter(survived == "Survived") |>
  summarise(
    std_dev = sd(humerus_length_in)
  ) |>
  pull()
pooled_sd <- sqrt((sd_died^2*23 + sd_lived^2*34)/57)
SE <- pooled_sd*sqrt(1/24 + 1/35)
t_stat <- obs_diff/(SE)
df <- 24 + 35 -2
p_value <- pt(t_stat, df, lower.tail = FALSE)
two_sided <- p_value*2
qt(0.025, 57)
qt(0.975, 57)
```
## Conceptual Exercises

### Problem 1
> In drawing conclusions about the Bumpus data , why might it be important to 
know whether all the birds were measured before the ones htat perished actually 
died?

If the birds' bodies change after death, this could distort the group
differences. It might be possible that the death of the birds is what is causing
a difference in mean humerus length.

There is also the possibility of measurement bias since the researcher measuring
the birds will know which ones are dead and alive and if they have a particular 
expectation it might result in them subtly changing the way that they make their
measurements of the individual specimens.

### Problem 2
> For comparing two population means when the population distributions have the 
same standard deviation, the standard deviation is sometimes referred to as a
nuisance parameter. Explain why it might be considered a nuisance.

The standard deviation is not generally of that much interest, but it must be
estimated from the data, because it is not usually known, in order to 
investigate the mean.

### Problem 3
>True or false? If the sample size is large, then the shape of the histogram of
the sample will be approximately normal, even if the population distribution is
not normal.

This is false. The histogram of the sample will approximate the population 
distribution. The larger the sample, the better the approximation of this
distribution.

### Problem 4
> True or false? If a sample size is large, then the shapre of the sampling
distribution will be approximately normal, even if the population distribution
is not normal.

This is true. This is the result of the central limit theorem. In particular,
the standard error of the sampling distribution will get smaller and tails of
the distribution will shrink.

### Problem 5
> Explain the relative merits of 90% and 99% levels of confidence.

The level of confidence is directly related to the width of the interval. A 
lower level of confidence results in a narrower interval which might provide
better constraint on the true value of the parameter, but you risk being wrong
in your estimate of the parameter and therefore the outcome of your hypothesis
test. You risk rejecting the null hypothesis when you should not. This is known
as a Type II error.

On the other hand, a high confidence level means that you are likely to capture
the true value of the parameter, but you are more likely to fail to reject the 
null hypothesis even though it is false. This is known as a Type I error.

The choice of confidence level is often governed by the penalty paid for making
a  Type I or II error. If a false possible would be a bad outcome, then a higher
confidence level is warranted. Perhaps you want to be very certain that you have
detected something real, in which case you would want to set $\alpha$ quite
small. On the other hand, if you want to avoid false negatives, a narrower
confidence interval will likely result in rejecting the null hypothesis.

### Problem 6
> What is wrong with the hypothesis that $\bar{Y}_2 - \bar{Y}_1 = 0$?

The hypothesis is about the population means $\mu_1, \mu_2$ not the sample 
means.

Kinda pedantic... but whatever.

### Problem 7
> In a study of the effects of marijuana use during pregnancy, measurements on 
babies of mothers who used marijuana during pregnancy were compared to 
measurements on babies of mothers who did not. A 95% confidence interval for the
difference in mean head circumference (nonuse minus use) was 0.61 to 1.19cm. 
What can be said from this statement about a *p*-value for the hypothesis that 
the mean difference is zero?

Since the interval does not contain zero, we know that the *p*-value is going to
be small. Since the confidence interval is $100(1-\alpha) = 95%$, we know that 
our threshold is $p=0.05$. We know that $p < 0.05$ given that the interval does 
not contain the hypothesised parameter value. 

### Problem 8
> Suppose the following statement is made in a statistical summary: "A 
comparison of breathing capacities of individuals in househols with low nitrogen
dioxide levels and individuals in households with high nitrogen dioxide levels 
indicated that there is not difference in the means 
(two-sided, *p*-value=0.24)". What is wrong with this statement?

The statement is too strong. When performing a hypothesis test, the null
hypothesis is not accepted, we simply fail to reject it. Stated another way, the
data collected are not consistent with the means being different, but that
doesn't rule out future data being incompatible with unequal means.

### Problem 9
> What is the difference (a) between the mean of $Y$ and the mean of $\bar{Y}$?
(b) the standard deviation of $Y$ and the standard deviation of $\bar{Y}$?(c) 
the standard deviation of $\bar{Y}$ and the standard error of $\bar{Y}$?(d) a 
t-ratio and a t-statistic?

(a) The mean of $Y$ is the population mean and as the mean of $\bar{Y}$ is the 
mean of the sampling distribution. In the limit as the sample size ($n$) goes to
infinite, the two values are equal.
(b) The standard deviation of the population ($Y$) is $\sigma$. The standard 
deviation of the sampling distribution is $\sigma/\sqrt{n}$. Notice that as 
$n \rightarrow \infty$ that the standard deviation of the sampling distribution
goes to zero, indicating that the population mean and the mean of the sampling
distribution converge.
(c) The standard deviation of $\bar{Y}$ and the standard error of $\bar{Y}$ are
the same thing. The standard error is called that because it tells us our best
guess about $\bar{Y} - \mu$. In other words, it's our best guess about how
far from the true mean our sample mean is.
(d) The t-ratio is the ratio of the error of the sample mean from the population
mean to the standard error of the sampling distribution. The t-ratio relates the
possible values of the population mean to a t-distribution with the appropriate
degrees of freedom based on the sample size. The t-statistic, on the other hand, 
is the ratio of the difference of means of two samples 
(of different populations) to a hypothesised difference in their population means
(typically taken to be zero) to the pooled standard error of the two samples.

*Addendum* - The t-ratio is generally not know because we don't actually know 
the population parameter. The t-statistic is a trial value of the t-ratio where
we use a hypothsised value of the parameter which we are testing with the NHST
framework.

### Problem 10
> Consider blood pressure levels for populations of young women using birth
control pills and young women not using birth control pills. A comparison of 
these populations through an observational study might be consisten with the 
theory that the pill elevates blood pressure levels. What tool is appropriate 
for addressing whether there is a difference between these two population? What 
tool is appropriate for addressing the likely size of the difference?

*p*-values are one way to access how likely it is that we would observe a 
difference equal to or more extreme than our data assuming that the null 
hypothesis of no difference is true.

A confidence interval constructed using the NHST framework will tell us what
percentage of sample means will fall within the range given by the confidence
interval. It is important to note that it doesn't say anything about whether our
data falls within this range. It is very easy to misinterpret frequentist
confidence intervals.

### Problem 11
> The data in Display 2.14 are survival times (in days) of guinea pigs that were
randomly assigned either to a control group or ato a treatment group that 
received a dose of tubercle bacilli. (a) Why might the additive treatment effect
model be inappropriate for these data? (b) Why might the ideal normal model with
equal spread be an inadequate approximation?

(a) The spread of data in the two groups doesn't suggest that the treatment 
group has merely experienced a shift in outcomes consistent with 
$Y^* = Y + \delta$. The control group has a larger variance (and also looks 
bimodal), so does not look like this model applies to this data.

(b) The ideal normal model doesn't apply here because the variance in the two 
groups is clearly different. The control group even appears to be bimodal, and 
so is not normally distributed.

## Computational Exercises

### Problem 12 - Marijuana Use During Pregnancy
> For the virth weights of babies in two groups, one born of mother who used 
marijuana during pregnancy and the other borm of mothers who did not, the 
difference in smaple averages (nonuser mothers minus user mothers) was 280 
grams, and the standard eorror of the difference was 46.66 grams with 1095 
degrees of freedom. From this information, provide the following: (a) a 95% 
confidence interval for $\mu_2 - \mu_1$, (c) a 90% confidence interval for 
$\mu_2 - \mu_1$,, and (c) the two-sided *p*-value for a test of the hypothesis 
that $\mu_2 - \mu_1 = 0$.



The test statistic for this hypothesis test is
$$
t = \frac{(\bar{Y}_2 - \bar{Y}_1) - 0}{\text{SE(difference)}} = \frac{280 - 0}{46.66} = `r round(280/46.66, 4)`
$$

```{r}
t_12 <- 280/46.66
ci_95 <- round(c(qt(0.025, df=1095), qt(0.975, df=1095)), 4)
ci_90 <- round(c(qt(0.05, df=1095), qt(0.95, df=1095)), 4)
p_12 <- 2*pt(t_12, df=1095, lower.tail = FALSE)
```



The 95% confidence interval is $[`r ci_95[1]`, `r ci_95[2]`]$.

The 90% confidence interval is $[`r ci_90[1]`, `r ci_90[2]`]$.

Because there are so many degrees of freedom, these t-distributions very closely
approximate the normal distribution, so the fact that these confidence intervals
closely resemble that of the standard normal is not surprising.

The two-sided *p*-value for this test is $p \approx `r round(p_12,4)`$ which makes sense
given the large ratio of the difference of means to the standard deviation of 
the difference in means.

### Problem 13
> Reconsider the changes in blood pressures for mean placed on a fish oil diet and for men placed on a regular oil diet. Do the following steps to compare the treatments:


(a) Compute the averates and the sample standard deviations for each group separately.
```{r}
fish_oil <- c(8,12,10,14,2,0,0)
regular_oil <- c(-6,0,1,2,-3,-4,2)

fish_bar <- mean(fish_oil)
regular_bar <- mean(regular_oil)

fish_s <- sd(fish_oil)
regular_s <- sd(regular_oil)
```

The average reduction in diastolic blood pressure for:

Fish oil group: $`r fish_bar`$
Regular oil group: $`r regular_bar`$

Standard deviations for the groups:

Fish oil group: $`r fish_s`$
Regular oil group: $`r regular_s`$

(b) Compute the pooled estimate of standard deviation using the formula in 
section 2.3.2.

The pooled standard deviation is just the square root of weighted average of the
variances.

$$
s_p = \sqrt{\frac{(n_1 - 1)s_1^2 + (n_2 - 1)s_2^2}{n_1 + n_2 - 2}}
$$

```{r}
n <- 14
n_1 <- n_2 <- n/2
s_p <- sqrt(((n_1-1)*fish_s^2 + (n_2-1)*regular_s^2)/(n_1 + n_2 - 2))
```

The pooled standard deviation is $`r round(s_p, 4)`$.

(c) Compute $SE(\bar{Y_2} - \bar{Y_1})$ using the formula in section 2.3.2.

```{r}
SE <- s_p*sqrt(1/n_1 + 1/n_2)
```

(d) What are the degrees of freedom associated with the pooled estimate of standard deviation? What is the 97.5th percentile of the *t*-distribution with this many degrees of freedom?

There are 12 degrees of freedom associated with the pooled standard deviation. 
We lose 2 degrees of freedom in computing the individual group standard 
deviations.

The 97.5th percentile for a t-distribution with 12 degrees of freedom is
$`r round(qt(0.975, df=12), 4)`$.

(e) Construct a 95% confidence interval for $\mu_2 - \mu_1$ using the formula in section 2.3.3.

```{r}
t_97.5 <- qt(0.975, df=12)

lower <- round((fish_bar - regular_bar) - SE*t_97.5,4)
upper <- round((fish_bar - regular_bar) + SE*t_97.5,4)
```
The 95% confidence interval is $[`r lower`, `r upper`]$.

(f) Compute the *t*-statistic for testing equality as shown in Section 2.3.5.

```{r}
t <- (fish_bar - regular_bar)/SE
```

The t-statistic for this test is $`r round(t, 4)`$.

(g) Find the one-sided *p*-value by comparing the *t*-statistic in (f) to the percentiles of the appropriate *t*-distribution.

The one-sided *p*-value for this test is 
$p=`r pt(t, df=12, lower.tail=FALSE)`$. Here, $p < 0.05$ and so we will
reject the null hypothesis that the means are equal at the $\alpha = 0.05$ 
level.

### Problem 14
> **Fish Oil and Blood Pressure**. Find the 95% confidence interval and one-sided *p*-valueasked for in Exercise 13(e) and (g) but use a statistical compute package to do so.

We'll use the `t.test` function from base R. We assume homoskedasticity by specifying `var.equal=TRUE`. This function produces very similar results to the manual calculation in problem 13. The *t*-statistic is very similar as is the *p*-value.

```{r}
t.test(fish_oil, regular_oil, alternative = "greater", var.equal = TRUE)
```
The confidence interval is a bit weird here. Not sure why the upper bound is 
$\infty$. The CI in problem 13 makes more sense, but I'm not sure which lower 
bound is correct. I can't any issues with the manually computed one in problem 
13. The other outputs agree nicely, so not sure what happened here.

### Problem 15
> **Auto exhaust and lead concentration in blood.** Researchers took independent
random samples from two populations of policemen and measure the level of lead
concentration in their blood. The sample of 126 police offices subjected to
constant inhalation of automobile exhaust fumes in downtown Cairo had an average
blood level concentration of $29.2\mu g/dl$ and an SD of $7.5 \mu g/dl$: a 
control sample of 50 policemen from the Cairo suburb of Abbasia, with no history
of exposure, had an average blood level concentration of $18.2 \mu g/dl$ and an 
SD of $5.8\mu g/dl$. Is there convincing evidence of a difference in the 
population means?

Here are the pieces of information that we're given:

- Average blood concentration for Abbasia police officers: $Y_{ap} = 18.2 \mu g/dl$
- Average blood concentration for Cairo police officers: $Y_{cp} = 29.2 \mu g/dl$
- Sample size of Abbasia police officers: $n_{ap} = 50$
- Sample size of Cairo police officers: $n_{cp} = 126$
- Standard deviation of blood concentration for Abbasia police officers: $s_{ap} = 5.8 \mu g/dl$
- Standard deviation of blood concentration for Cairo police officers: $s_{cp} = 7.5 \mu g/dl$

The difference in sample means is $Y_{cp} - Y_{ap} = 29.2 \mu g/dl - 18.2 \mu g/dl = 11.0 \mu g/dl$.

```{r}
n_cp <- 126
n_ap <- 50
Y_cp <- 29.2
Y_ap <- 18.2
mean_diff <- Y_cp - Y_ap
s_cp <- 7.5
s_ap <- 5.8

s_p <- sqrt(((n_cp - 1)*s_cp^2 + (n_ap - 1)*s_ap^2)/(n_cp + n_ap - 2))
SE <- s_p*sqrt(1/n_cp + 1/n_ap)
```

The pooled standard deviation for the two samples is given by
$$
\begin{align}
s_p &= \sqrt{\frac{(n_{cp} - 1)s_{cp}^2 + (n_{ap} - 1)s_{ap}^2}{n_{cp} + n_{ap} - 2}}\\[0.25cm]
 &= \sqrt{\frac{(126 - 1)7.5^2 + (50 - 1)5.8^2}{126 + 50 - 2}}\\[0.25cm]\\[0.25cm]
 &= `r round(s_p, 4)`
\end{align}
$$
The standard error of the sampling distribution is given by
$$
\begin{align}
SE(\bar{Y}_{cp} - \bar{Y}_{ap}) &= s_p\sqrt{\frac{1}{n_{cp}} + \frac{1}{n_{ap}}}\\[0.25cm]
&= `r round(s_p, 4)`\sqrt{\frac{1}{`r n_cp`} + \frac{1}{`r n_ap`}}\\[0.25cm]
&= `r round(SE, 4)`
\end{align}
$$
We have a total of $`r n_cp + n_ap`$ degrees of freedom, but since we're estimated the population standard deviations from data, we lose two of them, so our critical region will be defined by a *t*-distribution with $`r n_cp + n_ap - 2`$ degrees of freedom.

```{r}
t_97.5 <- qt(0.975, df=(n_cp + n_ap - 2))
t <- mean_diff/SE
```

The test statistic is computed using
$$
t = \frac{Y_{cp} - Y_{ap}}{SE} = \frac{`r Y_cp` - `r Y_ap`}{`r round(SE, 4)`} = `r round(t, 4)`
$$

The 95% confidence interval for the mean difference is
$$
\begin{align}
(\bar{Y}_{cp} - \bar{Y}_{ap}) &\pm t_{df}(1-\alpha/2)SE(\bar{Y}_{cp} - \bar{Y}_{ap})\\[0.25cm]
11.0 &\pm `r round(t_97.5, 4)`(`r round(SE,4)`)
\end{align}
$$
Note that a mean difference of zero is far from this confidence interval, so we expect a small *p*-value.

```{r}
p <- pt(t, df=(n_cp + n_ap - 2), lower.tail = FALSE)
```

$p = `r p`$. This *p*-value is **tiny**, so there is convincing evidence that the population means are different.

### Problem 16
> **Motivation and Creativity**. Verify the statements made in the summary of 
statistical findings for the Motivation and Creativity Data by analysing the 
data on the computer.

```{r problem 16}
intrinsic <- c(12.0,12.0,12.9,13.6,16.6,17.2,17.5,18.2,19.1,19.3,19.8,20.3,
               20.5,20.6,21.3,21.6,22.1,22.2,22.6,23.1,24.0,24.3,26.7,29.7)

extrinsic <- c(5.0,5.4,6.1,10.9,11.8,12.0,12.3,14.8,15.0,16.8,17.2,17.2,17.4,
               17.5,18.5,18.7,18.7,19.2,19.5,20.7,21.2,22.1,24.0)

n_i <- length(intrinsic)
n_e <- length(extrinsic)

mean_i <- mean(intrinsic)
mean_e <- mean(extrinsic)

sd_i <- sd(intrinsic)
sd_e <- sd(extrinsic)
```

Statistics

$$
\begin{align}
n_i = `r n_i`\\[0.25cm]
n_e = `r n_e`\\[0.25cm]
\bar{X}_i = `r round(mean_i,2)`\\[0.25cm]
\bar{X}_e = `r round(mean_e,2)`\\[0.25cm]
s_i = `r round(sd_i,2)`\\[0.25cm]
s_e = `r round(sd_e,2)`\\[0.25cm]
\end{align}
$$
```{r}
deg_f <- (n_i + n_e - 2)
s_p <- sqrt(((n_i - 1)*sd_i^2 + (n_e - 1)*sd_e^2)/(n_i + n_e - 2))
SE <- s_p*sqrt(1/n_i + 1/n_e)

t <- (mean_i - mean_e)/SE
t_97.5 <- qt(0.975, df=deg_f)

# compute two-sided p-value
p <- 2*pt(t, df=deg_f, lower.tail = FALSE)

lower <- (mean_i - mean_e) - t_97.5*SE
upper <- (mean_i - mean_e) + t_97.5*SE
```

Manually conducting the hypothesis test, we get the following results:

- Degrees of freedom: $`r deg_f`
- Pooled standard deviation: $`r round(s_p, 4)`$
- Standard Error: $`r round(SE, 4)`$
- Test statistic: $`r round(t,4)`$
- Critical region: $[-`r round(t_97.5, 4)`, `r round(t_97.5, 4)`]$
- 95% confidence interval: $[`r round(lower, 4)`, `r round(upper, 4)`]$
- *p*-value: $`r round(p, 4)`$


Hypothesis test using base R `t.test`:

```{r}
t.test(intrinsic, extrinsic, alternative = "two.sided", var.equal = TRUE)
```

Both the manual and `t.test` hypothesis tests produce results that closely match
those of the study's findings reported in statistical summary.

### Problem 17
>**Sex Discrimination**. Verify the statements made in the summary of statistical 
findings for the Sex Discrimination Data by analysing the ata on the computer.

```{r problem 17}
males <- c(4620,5040,5100,5100,5220,5400,5400,5400,5400,5400,5700,6000,6000,
           6000,6000,6000,6000,6000,6000,6000,6000,6000,6000,6000,6300,6600,
           6600,6600,6840,6900,6900,8100)
females <- c(3900,4020,4290,4380,4380,4380,4380,4380,4440,4500,4500,4620,4800,
             4800,4800,4800,4800,4800,4800,4800,4800,4800,4980,5100,5100,5100,
             5100,5100,5100,5160,5220,5220,5280,5280,5280,5400,5400,5400,5400,
             5400,5400,5400,5400,5400,5400,5400,5400,5520,5520,5580,5640,5700,
             5700,5700,5700,5700,6000,6000,6120,6300,6300)

n_m <- length(males)
n_f <- length(females)

mean_m <- mean(males)
mean_f <- mean(females)

sd_m <- sd(males)
sd_f <- sd(females)

deg_f <- n_m + n_f - 2
```

Basic statistics:

- Number of males: $`r n_m`$
- Number of females: $`r n_f`$
- Mean of males: $`r mean_m`$
- Mean of females: $`r mean_f`$
- Standard deviation of males: $`r sd_m`$
- Standard deviation of females: $`r sd_f`$
- Degrees of freedom: $`r deg_f`$

```{r}
s_p <- sqrt(((n_m - 1)*sd_m^2 + (n_f - 1)*sd_f^2)/deg_f)
SE <- s_p*sqrt(1/n_m + 1/n_f)
t <- (mean_m - mean_f)/SE
t_97.5 <- qt(0.975, df=deg_f)
lower <- (mean_m - mean_f) - t_97.5*SE
upper <- (mean_m - mean_f) + t_97.5*SE
p <- pt(t, df=deg_f, lower.tail = FALSE)
```

Manually conducting the hypothesis test, we get the following results:

- Pooled standard deviation: $`r round(s_p, 4)`$
- Standard Error: $`r round(SE, 4)`$
- Test statistic: $`r round(t,4)`$
- Critical region: $[-`r round(t_97.5, 4)`, `r round(t_97.5, 4)`]$
- 95% confidence interval: $[`r round(lower, 4)`, `r round(upper, 4)`]$
- *p*-value: $`r round(p, 4)`$

Hypothesis test using base R `t.test`:
```{r}
t.test(males, females, alternative = "greater", var.equal = TRUE)
```
### Problem 18
> **Bumpus's Data**. Verify the computations in Display 2.9 and Display 2.10 by 
analysing Bumpus's data on the computer.


```{r}
stat_died <- df_sparrows |>
  filter(survived == "Perished") |>
  summarise(
    n_p = n(),
    mean_p = mean(humerus_length_in),
    sd_p = sd(humerus_length_in)
  )

n_p <- stat_died |> pull(n_p)
mean_p <- stat_died |> pull(mean_p)
sd_p <- stat_died |> pull(sd_p)

stats_lived <- df_sparrows |>
  filter(survived == "Survived") |>
  summarise(
    n_l = n(),
    mean_l = mean(humerus_length_in),
    sd_l = sd(humerus_length_in)
  )

n_l <- stats_lived |> pull(n_l)
mean_l <- stats_lived |> pull(mean_l)
sd_l <- stats_lived |> pull(sd_l)

deg_f <- n_p + n_l - 2
```

Basic statistics:

- Number of perished: $`r n_p`$
- Number of survived: $`r n_l`$
- Mean of humerus length perished: $`r mean_p`$
- Mean of humerus length survived: $`r mean_l`$
- Standard deviation of humerus length perished: $`r sd_p`$
- Standard deviation of humerus length survived: $`r sd_l`$
- Degrees of freedom: $`r deg_f`$

```{r}
s_p <- sqrt(((n_p - 1)*sd_p^2 + (n_l - 1)*sd_l^2)/deg_f)
SE <- s_p*sqrt(1/n_p + 1/n_l)
t <- (mean_l - mean_p)/SE
t_97.5 <- qt(0.975, df=deg_f)

lower <- (mean_l - mean_p) - t_97.5*SE
upper <- (mean_l - mean_p) + t_97.5*SE

p <- 2*pt(t, df=deg_f)
```

Manually conducting the hypothesis test, we get the following results:

- Pooled standard deviation: $`r round(s_p, 4)`$
- Standard Error: $`r round(SE, 4)`$
- Test statistic: $`r round(t,4)`$
- Critical region: $[-`r round(t_97.5, 4)`, `r round(t_97.5, 4)`]$
- 95% confidence interval: $[`r round(lower, 4)`, `r round(upper, 4)`]$
- *p*-value (two-sided): $`r round(p, 4)`$

Hypothesis test using base R `t.test`:

```{r}
dead <- df_sparrows |>
  filter(survived == "Perished") |> 
  select(humerus_length_in) |> 
  pull()

alive <- df_sparrows |>
  filter(survived == "Survived") |> 
  select(humerus_length_in) |> 
  pull()
t.test(alive, dead, alternative = "two.sided", var.equal = TRUE)
```
These results are similar to those reported in the statistical summary.

### Problem 19
**Fish Oil and Blood Pressure.** Reconsider the fish oil and blood pressure data. Since the measurements are the 
reductions in blood pressure for each man, it is of interest to now whether the 
mean reduction is zero for each group. For the regular oil diet group do the 
following:

(a) Compute the average and the sample standard deviation. What are the degrees of freedom associated with the sample standard deviation, $s_2$?
(b) Compute the standard error for the average from this group: $SE(\bar{Y}_2) = s_2/\sqrt{n_2}$.
(c) Construct a 95% confidence interval for $\mu_2$ as $\bar{Y}_2 + t_d(0.975)SE(\bar{Y}_2)$, where $d$ is the degrees of freedom associated with $s_2$.
(d) For the hypothesis that $\mu_2=0$, construct the *t*-statistic $\bar{Y}_2/SE(\bar{Y}_2)$. Find the two-sided *p*-value as the proportion of values from a $t_d$ distribution farther from 0 than this value.

#### Part A
```{r}
regular_oil <- c(-6,0,1,2,-3,-4,2)

reg_bar <- mean(regular_oil)
sd_r <- sd(regular_oil)
```

The mean of sample is $\bar{Y}_2 = `r round(reg_bar, 4)`$.
The standard deviation of sample is $s_2 = `r round(sd_r, 4)`$.

There are 6 degrees of freedom associated with the standard deviation $(7-1)$ 
since one degree of freedom is "consumed" in calculating the mean.

#### Part B
```{r}
n_r <- length(regular_oil)
deg_f <- n_r - 1
SE <- sd_r/sqrt(n_r)
```

The standard error is $SE(\bar{Y}_2) = `r round(SE,4)`$.

#### Part C
```{r}
t_97.5 <- qt(0.975, df=deg_f)
lower <- round(reg_bar - t_97.5*SE,4)
upper <- round(reg_bar + t_97.5*SE,4)
```

The 95% confidence interval for $\mu_2$ is $[`r lower`, `r upper`]$.

#### Part D

```{r}
t <- reg_bar/SE
p <- 2*pt(t, df=deg_f)
```

The *t*-statistic for this hypothesis test is $t=`r round(t, 4)`.

The two-sided *p*-value is $p=`r round(p,4)`$, which indicates that the
hypothesis that $\mu_2=0$ is consistent with the data.

### Problem 20
> **Fish Oil and Blood Pressure (One-Sample Analysis).** Repeat Exercise 19 for 
the group of mean who were given the fish oil diet and then answer these 
questions: Is there any evidence that the mean reduction for this group is 
different from zero? What is the typical reduction in blood pressure expected 
from this type of diet (for individuals like these men)? Provide a 95% 
confidence interval.

```{r}
fish_oil <- c(8,12,10,14,2,0,0)

fish_bar <- mean(fish_oil)
sd_f <- sd(fish_oil)
n_f <- length(fish_oil)
deg_f <- n_f - 1

SE <- sd_f/sqrt(n_f)
t_97.5 <- qt(0.975, df=deg_f)

lower <- round(fish_bar - t_97.5*SE,2)
upper <- round(fish_bar + t_97.5*SE,2)

t <- fish_bar/SE
p <- round(2*pt(t, df=deg_f, lower.tail = FALSE), 2)
```

The typical reduction in blood pressure expected from this type of diet is 
$\mu_f$. Our best estimate of $\mu_f$ from this data is 
$\bar{Y}_f = `r round(fish_bar, 2)`$.

The 95% confidence interval for $\mu_f$ is $[`r lower`, `r upper`]$. Notice that
it does not contain zero. This suggests that the true population parameter is 
not zero.

The two-sided *p*-value for the hypothesis that $\mu_f = 0$ is $p=`r p`$. As a
result, we reject the null hypothesis, at the $\alpha = 0.05$ level in favour of
the alternative hypothesis that $\mu_f \neq 0$. With a more focused research
question, but would be more appropriate to choose a one-sided test, such as
$\mu_f > 0$, or that the population mean equals a specific non-zero value.

## Data Exercises

### Problem 21
> **Bumpus's Data: Weights of Birds that Survived and Perished.** The data that
Bumpus collected contains weight data, in grams, of 35 males house sparrows that
that survived and the 24 that perished from the severe winter storm. Analyse the
data using a graphical method; then use *t*-tools to say whether these 
distributions differ and by how much. Write a short summary report, similar to
the summaries in section 2.1.

#### The data
First, setup the individual vectors of data and then create a dataframe for
analysis.
```{r}
survived <- rep(c(TRUE, FALSE), times=c(35,24))
weights <- c(24.5,26.9,26.9,24.3,24.1,26.5,24.6,24.2,23.6,26.2,26.2,24.8,25.4,
             23.7,25.7,25.7,26.3,26.7,23.9,24.7,28.0,27.9,25.9,25.7,26.6,23.2,
             25.7,26.3,24.3,26.7,24.9,23.8,25.6,27.0,24.7,26.5,26.1,25.6,25.9,
             25.5,27.6,25.8,24.9,26.0,26.5,26.0,27.1,25.1,26.0,25.6,25.0,24.6,
             25.0,26.0,28.3,24.6,27.5,31.1,28.3)

df_weights <- tibble(survived, weight=weights)
```
A density plot of the data doesn't reveal any obvious data entry errors.
```{r}
theme_set(theme_minimal())
df_weights |> 
  ggplot(aes(x=weights, fill = survived)) +
  geom_density(alpha=0.4)
```
And now let's take a look at the bivariate distributions with a boxplot with the
individual data points jitter over the top. This way it is clear how many data
points are associated with each category of data.

```{r}
df_weights |> 
  ggplot(aes(x=survived, y=weight)) +
  geom_boxplot(outlier.alpha = 0) +
  geom_jitter(alpha=0.2, width = 0.2) +
  labs(
    y="Weight (g)"
  )
```

#### Compute summary statistics

```{r}
survived_mean_stats <- df_weights |> 
  filter(survived==TRUE) |> 
  summarise(
    mean_weight = mean(weight),
    sd_weight = sd(weight)
  )

perished_mean_stats <- df_weights |> 
  filter(survived==FALSE) |> 
  summarise(
    mean_weight = mean(weight),
    sd_weight = sd(weight)
  )

n_p <- 24
n_s <- 35
deg_f <- n_p + n_s - 2

survived_mean_weight <- survived_mean_stats |> pull(mean_weight)
survived_sd_weight <- survived_mean_stats |> pull(sd_weight)

perished_mean_weight <- perished_mean_stats |> pull(mean_weight)
perished_sd_weight <- perished_mean_stats |> pull(sd_weight)

diff_means <- (perished_mean_weight - survived_mean_weight)
```

- Mean weight for survivors: $`r round(survived_mean_weight, 1)`$
- Standard deviation of weights for survivors: $`r round(survived_sd_weight, 2)`$
- Mean weight for perished: $`r round(perished_mean_weight, 1)`$
- Standard deviation of weights for perished: $`r round(perished_sd_weight, 2)`$
- Sample size of survivors: $`r n_s`$
- Sample size of perished: $`r n_p`$
- difference of sample means: $`r round(diff_means, 1) `$ 

#### Perform a manual two-sample null hypothesis test

```{r}
sd_p <- sqrt(((n_s - 1)*survived_sd_weight^2 + (n_p - 1)*perished_sd_weight^2)/deg_f)
SE <- sd_p*sqrt(1/n_p + 1/n_s)
t_97.5 <- qt(0.975, df=deg_f)

lower <- round(diff_means - t_97.5*SE,4)
upper <- round(diff_means + t_97.5*SE,4)

t <- diff_means/SE
p <- 2*pt(t, df=deg_f, lower.tail = FALSE)
```

- Degrees of freedom: `r deg_f`
- Pooled standard deviation: $`r round(sd_p,2)`$
- Standard error: $`r SE`$
- 95% confidence interval for difference of means: $[`r lower`, `r upper`]$
- *t* statistic: $`r round(t, 4)`$
- *p*-value (two-sided): $`r round(p, 4)`$

#### Perform a *t*-test with base R

```{r}
df_weights |> 
  mutate(
    survived = factor(survived, labels = c("Perished", "Survived"))
  ) |> 
  t.test(weight ~ survived, data = _, alternative="two.sided", var.equal=TRUE)
```

#### Generate a linear model with a categorical predictor

```{r}
lm_weights <- lm(weight ~ survived, data=df_weights)
summary(lm_weights)
```
#### Summary of Statistical Analysis
There is strong evidence of a difference in mean weights with 
$\mu_p - \mu_s = `r round(diff_means, 1)`g$ with a 95% confidence interval of 
$`r lower`\text{ to }`r upper`$ grams. The two-sided *p*-value for the 
hypothesis test is $p=`r round(p,4)`$.

### Problem 22
> **Cholesterol in Urban and Rural Guatemalans.** An observational study to 
contrast cholesterol levels in rural and urban Guatemalan Indians came up with
the data. The samples are not random samples. Assess the difference in 
cholesterol distributions between the two populations. Write a summary 
statistical report, including a graphical display to illustrate your 
conclusions. What inferences are possible?

```{r}
location <- rep(c("urban", "rural"), times=c(45, 49))
cholesterol <- c(133,134,155,170,175,179,181,184,188,189,190,196,197,199,200,200,
                 201,201,204,205,205,205,206,214,217,222,222,227,227,228,234,
                 234,236,239,241,242,244,249,252,273,279,284,284,284,330,
                 # now the rural participants
                 95,108,108,114,115,214,129,129,131,131,135,136,136,139,140,142,
                 142,143,143,144,144,145,145,148,152,152,155,157,158,158,162,
                 165,166,171,172,173,174,175,180,181,189,192,194,197,204,220,
                 223,226,231)

df_chol <- tibble(location, cholesterol) |> 
  mutate(
    location = factor(location, levels=c("urban", "rural"))
  )

df_chol |> 
  ggplot(aes(x=location, y=cholesterol)) +
  geom_boxplot(outlier.alpha = 0) +
  geom_jitter(alpha=0.2, width = 0.15)
```

```{r}
df_chol |> 
  ggplot(aes(x=cholesterol, fill=location)) +
  geom_density(alpha=0.4)
```

#### Descriptive statistics

```{r}
urban_stats <- df_chol |> 
  filter(location == "urban") |> 
  summarise(
    mean_chol = mean(cholesterol),
    sd_chol = sd(cholesterol),
    sample_size = n()
  )

rural_stats <- df_chol |> 
  filter(location == "rural") |> 
  summarise(
    mean_chol = mean(cholesterol),
    sd_chol = sd(cholesterol),
    sample_size = n()
  )

urban_mean <- urban_stats |> pull(mean_chol)
urban_sd <- urban_stats |> pull(sd_chol)
n_u <- urban_stats |> pull(sample_size)

rural_mean <- rural_stats |> pull(mean_chol)
rural_sd <- rural_stats |> pull(sd_chol)
n_r <- rural_stats |> pull(sample_size)
```

- Mean of cholesterol for urban Guatemalans: $`r round(urban_mean, 1)`\%$.
- Standard deviation of cholesterol for urban Guatemalans: $`r round(urban_sd, 3)`\%$.
- Mean of cholesterol for rural Guatemalans: $`r round(rural_mean, 1)`\%$.
- Standard deviation of cholesterol for rural Guatemalans: $`r round(rural_sd, 3)`\%$.
- Sample size of urban Guatemalans: $`r n_u`$
- Sample size of rural Guatemalans: $`r n_r`$

#### Manual two-sample hypothesis test

```{r}
deg_f <- n_u + n_r - 2
s_p <- sqrt(((n_u)*urban_sd^2 + (n_r)*rural_sd^2)/deg_f)
SE <- s_p*sqrt(1/n_u + 1/n_r)
t_97.5 <- qt(0.975, df=deg_f)
diff_means <- urban_mean - rural_mean
t <- diff_means/SE
p <- 2*pt(diff_means, df=deg_f, lower.tail = FALSE)
lower <- round(diff_means - t_97.5*SE, 2)
upper <- round(diff_means + t_97.5*SE, 2)
```

- Degrees of freedom: `r deg_f`
- Pooled standard deviation: $`r round(sd_p,2)`$
- Standard error: $`r SE`$
- 95% confidence interval for difference of means: $[`r lower`, `r upper`]$
- *t* statistic: $`r round(t, 4)`$
- *p*-value (two-sided): $`r round(p, 4)`$

#### Hypotheis test with base R

```{r}
df_chol |> 
  t.test(cholesterol ~ location, data = _, alternative="two.sided", var.equal=TRUE)
```

```{r}
lm_chol <- lm(cholesterol ~ location, data = df_chol)
summary(lm_chol)
```

#### Summary of Statistical Analysis
There is strong evidence of a difference in mean cholesterol levels with 
$\mu_u - \mu_r = `r round(diff_means, 1)`g$ with a 95% confidence interval of 
$`r lower`\text{ to }`r upper`$ grams. The two-sided *p*-value for the 
hypothesis test is $p=`r round(p,4)`$.

### Problem 23
> **Speed Limits and Traffic fatalities**. The National Highway Safety System Designation Act was signed in to law in the United States on November 28, 1995. Among other things, the act abolished the federal mandate of 55 mile per hour maximum speed limits on roads in the United States and permitted states to establish their own limits. Of the 50 states (plus the District of Columbia), 32 increased their speed limits either at the beginning of 1996 or sometime during 1996. What evidence is there that the percentage change in interstate highway traffic fatalities was greater in states that increased their speed limits? How much of a difference is there? Write a brief statistical report detailing the answers to these questions.

```{r}
retained <- c(-29.0,-4.4, -80.0,-25.0,-13.2,-3.4,-5.4,-14.3,10.8,-20.0,44.1,-9.7,
              -50.0,-16.4,32.1,-41.2,-9.1,23.2,41.4)
increased <- c(24.5,0.0,41.3,4.4,-19.1,30.0,8.2,32.1,-17.9,9.4,41.4,-13.3,-1.8,
               33.3,-7.9,17.6,50.7,17.9,62.5,17.9,3.4,5.4,1.6,34.1,-7.0,18.2,
               22.2,4.0,14.8,9.4,34.3,-31.5)

speed_limit <- rep(c("Retained", "Increased"), times=c(19, 32))

df_speed_limits <- tibble(speed_limit, pct_change=c(retained, increased))
```

#### Visualise the univariate data

```{r}
df_speed_limits |> 
  ggplot(aes(x=pct_change)) +
  geom_histogram(colour="white", bins=15) +
  facet_wrap(~speed_limit)
```

#### Visualise the bivariate data

```{r}
df_speed_limits |> 
  ggplot(aes(x=speed_limit, y=pct_change)) +
  geom_boxplot(outlier.alpha = 0) +
  geom_jitter(alpha=0.2, width=0.2)
```

#### Descriptive statistics

```{r}
n_r <- length(retained)
n_i <- length(increased)
mean_retained <- mean(retained)
mean_increased <- mean(increased)
sd_retained <- sd(retained)
sd_increased <- sd(increased)
```

- Mean percent change in highway traffic fatalities for states who retained the 55 mph speed limit: $`r round(mean_retained, 1)`\%$.
- Standard deviation of percent change in highway traffic fatalities for states who retained the 55 mph speed limit: $`r round(sd_retained, 3)`\%$.
- Mean percent change in highway traffic fatalities for states who increased speed limit: $`r round(mean_increased, 1)`\%$.
- Standard deviation of percent change in highway traffic fatalities for states who increased speed limit: $`r round(sd_increased, 3)`\%$.
- Sample size of retaining states: $`r n_r`$
- Sample size of increasing states: $`r n_i`$

#### Manual hypothesis test $\mu_i > \mu_r$

```{r}
deg_f <- n_r + n_i - 2
s_p <- sqrt(((n_r - 1)*sd_retained^2 + (n_i - 1)*sd_increased^2)/deg_f)
SE <- s_p*sqrt(1/n_r + 1/n_i)
t_97.5 <- qt(0.975, df=deg_f)
diff_means <- mean_increased - mean_retained

lower <- round(diff_means - t_97.5*SE,1)
upper <- round(diff_means + t_97.5*SE,1)

t <- diff_means/SE
p <- pt(t, df=deg_f, lower.tail = FALSE)
```

- Degrees of freedom: `r deg_f`
- Pooled standard deviation: $`r round(sd_p,2)`$
- Standard error: $`r SE`$
- 95% confidence interval for difference of means: $[`r lower`, `r upper`]$
- *t* statistic: $`r round(t, 4)`$
- *p*-value (one-sided): $`r round(p, 4)`$

#### Hypothesis test of base R

```{r}
t.test(increased, retained, alternative = "greater", var.equal = TRUE)
```

The test using base R is in agreement with the manual *t* test.

#### Summary of Statistical Analysis
There is strong evidence of a difference in mean percent change with 
$\mu_i - \mu_r = `r round(diff_means, 1)`\%$ having a 95% confidence interval of 
$`r lower`\text{ to }`r upper`\%$ change. The one-sided *p*-value for the two-sample
hypothesis test is $p=`r round(p,4)`$. Based on the available data, there is 
strong evidence that raising speed limits is *correlated* with an increase in
highway traffic fatalities.
